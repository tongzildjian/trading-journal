<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tong's Home Finance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="./manifest.json">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-light: #eef2ff;
            --secondary: #64748b;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --kbank: #138f2d; --uob: #003366; --cimb: #e21a22; --ttb: #f26522; --house: #8b5cf6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Prompt', sans-serif; padding-bottom: 50px; }
        .card { background-color: var(--card-bg); border: none; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Dashboard Header */
        .dash-header { background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%); color: white; padding: 35px 25px; border-radius: 0 0 40px 40px; margin-bottom: -30px; position: relative; z-index: 1; }
        .dash-value { font-size: 36px; font-weight: 800; }
        .dash-label { font-size: 13px; opacity: 0.9; font-weight: 500; text-transform: uppercase; }
        
        /* Summary Row */
        .summary-container { position: relative; z-index: 2; padding: 0 15px; }
        .summary-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        
        /* Bank Icons */
        .bank-badge { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 8px; font-weight: 800; font-size: 14px; }
        .bank-item { text-align: center; flex: 1; padding: 5px; }
        .bank-amount { font-size: 12px; font-weight: 700; color: var(--text-main); }
        
        /* Inputs */
        .form-control, .form-select { background-color: #f1f5f9; border: 2px solid transparent; border-radius: 16px; padding: 12px 18px; font-weight: 500; }
        .form-control:focus { background-color: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .btn-primary { background: var(--primary); border: none; border-radius: 16px; padding: 15px; font-weight: 700; transition: 0.3s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Tabs */
        .nav-pills { background: #e2e8f0; border-radius: 20px; padding: 5px; }
        .nav-pills .nav-link { border-radius: 16px; color: var(--secondary); font-weight: 600; padding: 10px; }
        .nav-pills .nav-link.active { background: var(--primary); color: white; }

        .type-pill { padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; display: inline-block; }
        .type-fixed { background: #fee2e2; color: #b91c1c; }
        .type-extra { background: #fef3c7; color: #b45309; }

        #syncStatus { font-size: 11px; }
        .history-item { border-bottom: 1px solid #f1f5f9; padding: 15px 0; }
        .history-item:last-child { border: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="dash-header">
        <div class="container text-center">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div style="width: 40px;"></div> <!-- Spacer -->
                <div>
                    <div class="dash-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
                    <div class="dash-value" id="netBalance">‡∏ø0.00</div>
                </div>
                <button class="btn btn-link text-white p-0" onclick="loadData()" style="width: 40px;">
                    <i class="fas fa-sync-alt" id="headerSyncBtn"></i>
                </button>
            </div>
            <div id="syncStatus" class="opacity-75">
                <i class="fas fa-circle-notch fa-spin me-1" id="syncIcon"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...
            </div>
        </div>
    </div>

    <div class="summary-container">
        <div class="summary-card">
            <div class="row text-center g-0">
                <div class="col-4 border-end">
                    <div class="dash-label text-muted">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
                    <div class="fw-bold text-success" id="totalIncome">‡∏ø0.00</div>
                </div>
                <div class="col-4 border-end">
                    <div class="dash-label text-muted">‡∏á‡∏ß‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                    <div class="fw-bold text-danger" id="totalFixed">‡∏ø0.00</div>
                </div>
                <div class="col-4">
                    <div class="dash-label text-muted">‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
                    <div class="fw-bold text-warning" id="totalExtra">‡∏ø0.00</div>
                </div>
            </div>
            
            <hr class="my-3 opacity-50">
            
            <!-- Bank Grid -->
            <div class="d-flex justify-content-between">
                <div class="bank-item">
                    <div class="bank-badge mx-auto" style="background: var(--kbank);">KB</div>
                    <div class="bank-amount" id="val-KBANK">0</div>
                </div>
                <div class="bank-item">
                    <div class="bank-badge mx-auto" style="background: var(--uob);">UO</div>
                    <div class="bank-amount" id="val-UOB">0</div>
                </div>
                <div class="bank-item">
                    <div class="bank-badge mx-auto" style="background: var(--ttb);">TT</div>
                    <div class="bank-amount" id="val-TTB">0</div>
                </div>
                <div class="bank-item">
                    <div class="bank-badge mx-auto" style="background: var(--cimb);">CI</div>
                    <div class="bank-amount" id="val-CIMB">0</div>
                </div>
                <div class="bank-item">
                    <div class="bank-badge mx-auto" style="background: var(--house);">üè°</div>
                    <div class="bank-amount" id="val-HOUSE">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <ul class="nav nav-pills mb-4 nav-fill" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-add">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chart">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-setting">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button></li>
        </ul>

        <div class="tab-content">
            <!-- Tab: Add -->
            <div class="tab-pane fade show active" id="tab-add">
                <div class="card p-4">
                    <form id="financeForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <select class="form-select" id="mainType" required>
                                <option value="Income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                                <option value="Fixed">üìÖ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏á‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏ú‡πà‡∏≠‡∏ô)</option>
                                <option value="Extra">üõçÔ∏è ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏Å‡∏¥‡∏ô/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select class="form-select" id="category" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <input type="number" step="0.01" class="form-control form-control-lg text-primary" id="amount" placeholder="0.00" required>
                        </div>
                        <div class="mb-4">
                            <input type="text" class="form-control" id="description" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏ß‡∏î 5/48, ‡∏Å‡∏¥‡∏ô‡∏£‡πâ‡∏≤‡∏ô...)">
                        </div>
                        <button type="submit" id="saveBtn" class="btn btn-primary w-100 shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</button>
                    </form>
                </div>
                
                <div class="mt-4 px-2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                        <button class="btn btn-sm btn-light rounded-pill" onclick="loadData()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <div class="card p-3" id="miniHistory"></div>
                </div>
            </div>

            <!-- Tab: Chart -->
            <div class="tab-pane fade" id="tab-chart">
                <div class="card p-4 mb-4">
                    <h6 class="fw-bold mb-3">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h6>
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <div class="small text-muted">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
                            <div class="h5 fw-bold text-success" id="report-income">‡∏ø0.00</div>
                        </div>
                        <div class="col-6">
                            <div class="small text-muted">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="h5 fw-bold text-danger" id="report-total-expense">‡∏ø0.00</div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                        <div class="card p-3 h-100">
                            <h6 class="fw-bold mb-3 text-center" style="font-size: 14px;">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>
                            <div style="height: 200px;"><canvas id="incomeChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card p-3 h-100">
                            <h6 class="fw-bold mb-3 text-center" style="font-size: 14px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (Fixed)</h6>
                            <div style="height: 200px;"><canvas id="fixedChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card p-3 h-100">
                            <h6 class="fw-bold mb-3 text-center" style="font-size: 14px;">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Extra)</h6>
                            <div style="height: 200px;"><canvas id="expenseChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <h6 class="fw-bold mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                    <div id="fullHistory"></div>
                </div>
            </div>

            <!-- Tab: Setting -->
            <div class="tab-pane fade" id="tab-setting">
                <div class="card p-4">
                    <h6 class="fw-bold text-danger mb-3">‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h6>
                    <p class="small text-muted">‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÉ‡∏ô Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                    <button class="btn btn-outline-danger w-100 py-3" onclick="clearAllData()">
                        <i class="fas fa-trash-alt me-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Google Sheet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbyLG7ISUswAanVxDzH9iVkIr3D0eWa-l7FS4RPx8B9bFDaodLQfD4ShLs5EfD3Krl4cZw/exec';
        
        const CATEGORIES = {
            "Income": ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥", "Freelance", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
            "Fixed": ["‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ú‡πà‡∏≠‡∏ô KBank (‡∏á‡∏ß‡∏î)", "‡∏ú‡πà‡∏≠‡∏ô CIMB (‡∏á‡∏ß‡∏î)", "‡∏ú‡πà‡∏≠‡∏ô UOB (‡∏á‡∏ß‡∏î)", "‡∏ú‡πà‡∏≠‡∏ô TTB (‡∏á‡∏ß‡∏î)", "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï"],
            "Extra": ["‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô/‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏ï‡∏¥‡∏° Gas LPG/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á Shopee/Lazada", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)"]
        };

        let allData = [];
        let expenseChart;

        // --- UTILITIES ---
        function setSyncStatus(text, type) {
            const el = document.getElementById('syncStatus');
            const icon = document.getElementById('syncIcon');
            el.innerHTML = `<i class="fas fa-circle-notch ${type === 'secondary' ? 'fa-spin' : ''} me-1" id="syncIcon"></i> ${text}`;
            el.className = `opacity-75 text-${type === 'secondary' ? 'white' : type}`;
        }

        function setupCategories() {
            const cat = document.getElementById('category');
            cat.innerHTML = '';
            const type = document.getElementById('mainType').value;
            CATEGORIES[type].forEach(c => cat.innerHTML += `<option value="${c}">${c}</option>`);
        }
        document.getElementById('mainType').onchange = setupCategories;
        setupCategories();

        async function loadData() {
            setSyncStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...", "secondary");
            try {
                const response = await fetch(CLOUD_URL + '?t=' + Date.now());
                const raw = await response.json();
                allData = Array.isArray(raw) ? raw.map(r => ({
                    date: r[1], 
                    type: r[2], 
                    category: r[3], 
                    amount: parseFloat(r[4]) || 0, 
                    desc: r[5] || ''
                })).filter(t => t.amount > 0) : [];
                
                console.log("Loaded Data:", allData); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                updateUI();
                setSyncStatus("‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", "white");
            } catch(e) {
                console.error("Fetch Error:", e);
                setSyncStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "danger");
            }
        }

        document.getElementById('financeForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('saveBtn'); btn.disabled = true;
            const data = {
                date: new Date().toISOString().split('T')[0],
                type: document.getElementById('mainType').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                description: document.getElementById('description').value
            };
            try {
                await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                setTimeout(() => { loadData(); this.reset(); setupCategories(); btn.disabled = false; }, 2000);
            } catch(e) { btn.disabled = false; }
        };

        async function clearAllData() {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!")) return;
            setSyncStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...", "warning");
            try {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GAS ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á Type: "CLEAR" ‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î GAS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
                await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "CLEAR_ALL" }) });
                alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö");
                setTimeout(loadData, 3000);
            } catch(e) { alert("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
        }

        function updateUI() {
            const now = new Date();
            const curMonth = now.getMonth(), curYear = now.getFullYear();
            
            const filtered = allData.filter(t => {
                const d = new Date(t.date); // ‡πÉ‡∏ä‡πâ new Date() ‡∏ï‡∏£‡∏á‡πÜ ‡∏Å‡∏±‡∏ö ISO String
                return !isNaN(d.getTime()) && d.getMonth() === curMonth && d.getFullYear() === curYear;
            });

            let inc = 0, fix = 0, ext = 0;
            const bankMap = {"KBANK":0, "TTB":0, "UOB":0, "CIMB":0, "HOUSE":0};
            const catMap = {};

            filtered.forEach(t => {
                if(t.type === 'Income') inc += t.amount;
                else {
                    if(t.type === 'Fixed') fix += t.amount; else ext += t.amount;
                    if(t.type === 'Extra') catMap[t.category] = (catMap[t.category] || 0) + t.amount;
                    
                    const catName = t.category.toUpperCase();
                    if(catName.includes("KBANK")) bankMap["KBANK"] += t.amount;
                    if(catName.includes("TTB")) bankMap["TTB"] += t.amount;
                    if(catName.includes("UOB")) bankMap["UOB"] += t.amount;
                    if(catName.includes("CIMB")) bankMap["CIMB"] += t.amount;
                    if(catName.includes("‡∏ö‡πâ‡∏≤‡∏ô") || catName.includes("HOUSE")) bankMap["HOUSE"] += t.amount;
                }
            });

            const fmt = (v) => v.toLocaleString('th-TH', { minimumFractionDigits: 2 });
            document.getElementById('netBalance').innerText = '‡∏ø' + fmt(inc - fix - ext);
            document.getElementById('totalIncome').innerText = '‡∏ø' + fmt(inc);
            document.getElementById('totalFixed').innerText = '‡∏ø' + fmt(fix);
            document.getElementById('totalExtra').innerText = '‡∏ø' + fmt(ext);
            
            for(let k in bankMap) document.getElementById(`val-${k}`).innerText = fmt(bankMap[k]);

            // History
            const mini = document.getElementById('miniHistory');
            const full = document.getElementById('fullHistory');
            mini.innerHTML = ''; full.innerHTML = '';
            
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((t, i) => {
                const d = new Date(t.date);
                const dateStr = d.toLocaleDateString('th-TH');
                const item = `
                    <div class="history-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold" style="font-size:14px;">${t.category}</div>
                            <div class="type-pill ${t.type==='Fixed'?'type-fixed':'type-extra'}">${t.type==='Fixed'?'‡∏á‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥':'‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</div>
                            <span class="small text-muted ms-2">${dateStr}</span>
                        </div>
                        <div class="fw-bold ${t.type==='Income'?'text-success':'text-danger'}">${t.type==='Income'?'+':'-'}${t.amount.toLocaleString()}</div>
                    </div>`;
                if(i < 5) mini.innerHTML += item;
                full.innerHTML += item;
            });

            updateChart(catMap);
        }

        function updateChart(map) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(map),
                    datasets: [{ data: Object.values(map), backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } } }
            });
        }

        loadData();
    </script>
</body>
</html>
